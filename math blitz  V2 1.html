<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Blitz Football</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0b3d91;
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      max-width: 500px;
      width: 100%;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 2px 2px #ffb400;
    }

    /* Welcome Screen Styles */
    .welcome-screen {
      background: #062b59;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 20px;
    }

    .welcome-screen h2 {
      color: white;
      margin-bottom: 20px;
    }

    .name-input {
      width: 90%;
      padding: 12px;
      margin: 15px 0;
      border: none;
      border-radius: 8px;
      font-size: 1.2em;
      text-align: center;
      background: white;
      color: #0b3d91;
    }

    .name-input:focus {
      outline: 2px solid #ffb400;
      box-shadow: 0 0 5px #ffb400;
    }

    .avatar-selection {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .avatar-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }

    .avatar-option:hover {
      transform: scale(1.02);
    }

    .avatar-option.selected {
      border-color: #ffb400;
      transform: scale(1.05);
    }

    .avatar-icon {
      width: 40px;
      height: 80px;
      margin-bottom: 10px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-number {
      color: white;
      font-weight: bold;
      font-size: 1.2em;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .avatar-option span {
      margin-top: 5px;
      font-weight: bold;
    }

    /* Team Colors */
    .bengals { background: #FB4F14; color: #000000; }
    .eagles { background: #004C54; color: #A5ACAF; }
    .cowboys { background: #003594; color: #869397; }
    .niners { background: #AA0000; color: #B3995D; }
    .bills { background: #00338D; color: #C60C30; }
    .chiefs { background: #E31837; color: #FFB81C; }

    .start-button {
      width: 90%;
      padding: 15px;
      margin-top: 20px;
      background: #ffb400;
      border: none;
      border-radius: 10px;
      color: #0b3d91;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .start-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #cccccc;
    }

    .start-button:not(:disabled):hover {
      background: #ffd700;
      transform: scale(1.02);
    }

    .error-message {
      color: #ff4444;
      font-size: 0.9em;
      margin-top: 5px;
      min-height: 1.2em;
    }

    /* Difficulty Selection Screen */
    .difficulty-screen {
      display: none;
      background: #062b59;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 20px;
    }

    .difficulty-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      background: #ffb400;
      border: none;
      border-radius: 10px;
      color: #0b3d91;
      cursor: pointer;
      font-size: 1.2em;
      font-weight: bold;
      transition: all 0.3s;
    }

    .difficulty-button .description {
      font-size: 0.8em;
      opacity: 0.8;
      display: block;
      margin-top: 5px;
    }

    .difficulty-button.locked {
      background: #cccccc;
      cursor: not-allowed;
      opacity: 0.7;
      color: #666;
    }

    .difficulty-button.locked::after {
      content: "ðŸ”’";
      margin-left: 10px;
    }

    .difficulty-button.unlocked {
      background: #ffb400;
    }

    /* Game Interface */
    #game-interface {
      display: none;
    }

    .scoreboard {
      background: #062b59;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .scoreboard-item {
      text-align: center;
      padding: 5px;
      background: #0b3d91;
      border-radius: 5px;
    }

    .field-container {
      background: #2d5a27;
      height: 100px;
      position: relative;
      border-radius: 5px;
      margin-bottom: 20px;
      background-image: repeating-linear-gradient(
        to right,
        #2d5a27,
        #2d5a27 9%,
        #275423 9%,
        #275423 10%
      );
      border: 2px solid white;
    }

    .yard-markers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 5px;
    }

    .yard-marker {
      color: white;
      font-size: 12px;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    .football {
      position: absolute;
      left: 20%;
      top: 40px;
      width: 30px;
      height: 20px;
      background: #964B00;
      border-radius: 50%;
      transition: left 0.5s;
      z-index: 2;
    }

    .player {
      position: absolute;
      width: 20px;
      height: 40px;
      background: #ffb400;
      bottom: 0;
      left: 20%;
      transition: left 0.5s;
      z-index: 1;
    }

    .game-screen {
      background: #062b59;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      display: none;
    }

    .question {
      font-size: 2em;
      text-align: center;
      margin-bottom: 20px;
      background: #0b3d91;
      padding: 15px;
      border-radius: 10px;
    }

    .answer-display {
      background: #1a1a1a;
      color: #ffd700;
      padding: 10px;
      text-align: right;
      font-size: 1.5em;
      margin-bottom: 15px;
      border-radius: 5px;
      min-height: 40px;
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .keypad button {
      font-size: 1.5em;
      padding: 15px;
      background-color: #ffb400;
      color: #0b3d91;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 3px 3px #062b59;
    }

    .submit-button {
      width: 100%;
      padding: 15px;
      background: #ffb400;
      border: none;
      border-radius: 10px;
      color: #0b3d91;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
    }

    .notification-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .notification-content {
      text-align: center;
      padding: 40px;
      border-radius: 20px;
      animation: scaleIn 0.5s ease-out;
    }

    .notification-content h2 {
      font-size: 3em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      white-space: pre-line;
    }

    .notification-content.success {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .notification-content.warning {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .stats-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #062b59;
      padding: 20px;
      border-radius: 15px;
      z-index: 1000;
      max-width: 80%;
      width: 400px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: #0b3d91;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .modal-button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      background: #ffb400;
      color: #0b3d91;
    }

    .print-button {
      background: #4CAF50;
      color: white;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @media print {
      .modal-buttons {
        display: none;
      }
      body {
        background: white;
        color: black;
      }
      .stat-item {
        border: 1px solid black;
      }
    }

    @media (max-width: 500px) {
      .scoreboard {
        grid-template-columns: 1fr;
      }
      
      .yard-marker {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Math Blitz Football</h1>
    
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcome-screen">
      <h2>Welcome to Math Blitz!</h2>
      <input type="text" 
             class="name-input" 
             id="player-name" 
             placeholder="Enter your name (letters and numbers only)"
             maxlength="20">
      <div class="error-message" id="name-error"></div>
      
      <h3>Choose Your Player</h3>
      <div class="avatar-selection">
        <div class="avatar-option bengals" data-team="bengals">
          <div class="avatar-icon">
            <span class="avatar-number">85</span>
          </div>
          <span>Bengals</span>
        </div>
        <div class="avatar-option eagles" data-team="eagles">
          <div class="avatar-icon">
            <span class="avatar-number">11</span>
          </div>
          <span>Eagles</span>
        </div>
        <div class="avatar-option cowboys" data-team="cowboys">
          <div class="avatar-icon">
            <span class="avatar-number">88</span>
          </div>
          <span>Cowboys</span>
        </div>
        <div class="avatar-option niners" data-team="niners">
          <div class="avatar-icon">
            <span class="avatar-number">85</span>
          </div>
          <span>49ers</span>
        </div>
        <div class="avatar-option bills" data-team="bills">
          <div class="avatar-icon">
            <span class="avatar-number">17</span>
          </div>
          <span>Bills</span>
        </div>
        <div class="avatar-option chiefs" data-team="chiefs">
          <div class="avatar-icon">
            <span class="avatar-number">87</span>
          </div>
          <span>Chiefs</span>
        </div>
      </div>
      <button class="start-button" id="start-button" disabled>Start Game</button>
    </div>

    <!-- Difficulty Selection Screen -->
    <div class="difficulty-screen" id="difficulty-screen">
  <h2>Select Your Difficulty</h2>
  <button class="difficulty-button unlocked" data-difficulty="rookie">
    Rookie
    <span class="description">Basic Single Digit Multiplication (1-9)</span>
  </button>
  <button class="difficulty-button locked" data-difficulty="pro">
    Pro
    <span class="description">Times Tables (5-9)</span>
  </button>
  <button class="difficulty-button locked" data-difficulty="allPro">
    All Pro
    <span class="description">Double Digit Ã— Single Digit</span>
  </button>
  <button class="difficulty-button locked" data-difficulty="allMadden">
    All Madden
    <span class="description">Double/Triple Digit Ã— Double Digit</span>
  </button>
</div>

    <!-- Game Interface -->
    <div id="game-interface" style="display: none;">
      <div class="scoreboard">
        <div class="scoreboard-item">Down: <span id="down">1</span></div>
        <div class="scoreboard-item">To Go: <span id="to-go">10</span></div>
        <div class="scoreboard-item">Ball On: <span id="field-position">20</span></div>
        <div class="scoreboard-item">Time: <span id="timer">0:00</span></div>
      </div>

      <div class="field-container">
        <div class="yard-markers">
          <div class="yard-marker">0</div>
          <div class="yard-marker">10</div>
          <div class="yard-marker">20</div>
          <div class="yard-marker">30</div>
          <div class="yard-marker">40</div>
          <div class="yard-marker">50</div>
          <div class="yard-marker">40</div>
          <div class="yard-marker">30</div>
          <div class="yard-marker">20</div>
          <div class="yard-marker">10</div>
          <div class="yard-marker">0</div>
        </div>
        <div class="football" id="football"></div>
        <div class="player" id="player"></div>
      </div>

      <div class="game-screen" id="game-screen">
        <div class="question" id="question"></div>
        <div class="answer-display" id="answer-display">0</div>
        <div class="keypad" id="keypad"></div>
        <button class="submit-button" id="submit-button">SNAP!</button>
      </div>
    </div>

    <!-- Stats Modal -->
    <div class="stats-modal" id="stats-modal">
      <h2>Drive Summary</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <div>Difficulty Level</div>
          <div id="difficulty-level">Rookie</div>
        </div>
        <div class="stat-item">
          <div>Average Time</div>
          <div id="avg-time">0s</div>
        </div>
        <div class="stat-item">
          <div>Accuracy</div>
          <div id="accuracy">0%</div>
        </div>
        <div class="stat-item">
          <div>Total Yards</div>
          <div id="total-yards">0</div>
        </div>
        <div class="stat-item">
          <div>First Downs</div>
          <div id="first-downs">0</div>
        </div>
        <div class="stat-item">
          <div>Total Questions</div>
          <div id="total-questions">0</div>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-button print-button" onclick="printStats()">Print Stats</button>
      </div>
    </div>
  </div>

  <script>
    let gameState = {
      playerName: '',
      playerTeam: '',
      difficulty: null,
      unlockedLevels: ['rookie'],
      down: 1,
      toGo: 10,
      fieldPosition: 20,
      currentProblem: null,
      userAnswer: '0',
      questionStartTime: 0,
      usedQuestions: [],
      driveStats: {
        attempts: 0,
        correct: 0,
        totalTime: 0,
        firstDowns: 0,
        totalYards: 0
      }
    };

    const teamColors = {
      bengals: { primary: '#FB4F14', secondary: '#000000' },
      eagles: { primary: '#004C54', secondary: '#A5ACAF' },
      cowboys: { primary: '#003594', secondary: '#869397' },
      niners: { primary: '#AA0000', secondary: '#B3995D' },
      bills: { primary: '#00338D', secondary: '#C60C30' },
      chiefs: { primary: '#E31837', secondary: '#FFB81C' }
    }
	
	;function initializeWelcomeScreen() {
      const nameInput = document.getElementById('player-name');
      const startButton = document.getElementById('start-button');
      const avatarOptions = document.querySelectorAll('.avatar-option');
      let selectedAvatar = null;

      // Check for stored name
      const storedName = sessionStorage.getItem('playerName');
      if (storedName) {
        nameInput.value = storedName;
        validateForm();
      }

      nameInput.addEventListener('input', validateForm);

      function validateForm() {
        const name = nameInput.value.trim();
        const errorElement = document.getElementById('name-error');
        const isValid = /^[A-Za-z0-9]+$/.test(name);
        
        if (!name) {
          errorElement.textContent = 'Please enter your name';
          startButton.disabled = true;
        } else if (!isValid) {
          errorElement.textContent = 'Only letters and numbers allowed';
          startButton.disabled = true;
        } else {
          errorElement.textContent = '';
          startButton.disabled = !selectedAvatar;
        }
      }

      avatarOptions.forEach(option => {
        option.addEventListener('click', () => {
          avatarOptions.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
          selectedAvatar = option.dataset.team;
          validateForm();
        });
      });

      startButton.addEventListener('click', () => {
        if (nameInput.value.trim() && selectedAvatar) {
          gameState.playerName = nameInput.value.trim();
          gameState.playerTeam = selectedAvatar;
          sessionStorage.setItem('playerName', nameInput.value.trim());
          document.getElementById('welcome-screen').style.display = 'none';
          document.getElementById('difficulty-screen').style.display = 'block';
          updatePlayerDisplay();
        }
      });
    }

    function updatePlayerDisplay() {
      const avatar = document.querySelector('.player-avatar');
      const nameDisplay = document.getElementById('player-name-display');
      if (avatar && nameDisplay) {
        const colors = teamColors[gameState.playerTeam];
        avatar.style.backgroundColor = colors.primary;
        avatar.style.color = colors.secondary;
        nameDisplay.textContent = gameState.playerName;
      }
    }

    function showNotification(type, message, duration = 2000) {
      const overlay = document.createElement('div');
      overlay.className = 'notification-overlay';
      
      const content = document.createElement('div');
      content.className = `notification-content ${type}`;
      
      const title = document.createElement('h2');
      title.innerText = message;
      content.appendChild(title);
      
      const emoji = document.createElement('div');
      emoji.style.fontSize = '4em';
      emoji.innerText = type === 'success' ? 'ðŸˆ' : 'ðŸ›‘';
      content.appendChild(emoji);
      
      overlay.appendChild(content);
      document.body.appendChild(overlay);
      
      overlay.style.display = 'flex';
      
      setTimeout(() => {
        overlay.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(overlay);
        }, 300);
      }, duration);
    }

    function getYardRange() {
      switch(gameState.difficulty) {
        case 'rookie':
          return { min: 3, max: 6 };
        case 'pro':
          return { min: 4, max: 8 };
        case 'allPro':
          return { min: 5, max: 10 };
        case 'allMadden':
          return { min: 6, max: 12 };
      }
    }

    function generateProblem() {
      let num1, num2;
      let attempts = 0;
      let questionKey;
      
      do {
        switch(gameState.difficulty) {
          case 'rookie':
            num1 = Math.floor(Math.random() * 9) + 1;
            num2 = Math.floor(Math.random() * 9) + 1;
            if (num1 < 3 && num2 < 3) {
              num1 += 3;
            }
            break;
          case 'pro':
            num1 = Math.floor(Math.random() * 5) + 5;
            num2 = Math.floor(Math.random() * 5) + 5;
            break;
          case 'allPro':
            num1 = Math.floor(Math.random() * 90) + 10;
            num2 = Math.floor(Math.random() * 9) + 1;
            break;
          case 'allMadden':
            num1 = Math.floor(Math.random() * 900) + 100;
            num2 = Math.floor(Math.random() * 90) + 10;
            break;
        }

        questionKey = `${Math.min(num1, num2)}x${Math.max(num1, num2)}`;
        attempts++;
      } while (
        gameState.usedQuestions.includes(questionKey) && 
        attempts < 50 &&
        gameState.usedQuestions.length < getMaxQuestions(gameState.difficulty)
      );
      
      gameState.usedQuestions.push(questionKey);
      
      gameState.currentProblem = {
        num1: num1,
        num2: num2,
        answer: num1 * num2
      };
      
      document.getElementById('question').innerText = `${num1} Ã— ${num2}`;
      gameState.questionStartTime = Date.now();
    }

    function getMaxQuestions(difficulty) {
      switch(difficulty) {
        case 'rookie': return 81;
        case 'pro': return 25;
        case 'allPro': return 890;
        case 'allMadden': return 89100;
        default: return 100;
      }
    }

    function exportToCSV(data) {
      const csvRows = [];
      const headers = Object.keys(data);
      csvRows.push(headers.join(','));

      const row = headers.map(header => {
        let value = data[header];
        if (typeof value === 'string' && value.includes(',')) {
          value = `"${value}"`;
        }
        return value;
      });
      csvRows.push(row.join(','));

      const csvString = csvRows.join('\n') + '\n';
      const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'MathBlitz_Results.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    function saveGameResults() {
      const now = new Date();
      const data = {
        Name: gameState.playerName,
        DateTime: now.toISOString(),
        Difficulty: gameState.difficulty,
        QuestionsAttempted: gameState.driveStats.attempts,
        CorrectAnswers: gameState.driveStats.correct,
        Accuracy: ((gameState.driveStats.correct / gameState.driveStats.attempts) * 100).toFixed(1),
        AvgResponseTime: (gameState.driveStats.totalTime / gameState.driveStats.attempts).toFixed(1),
        TotalTime: gameState.driveStats.totalTime.toFixed(1)
      };
      exportToCSV(data);
    }
	function startGame(difficulty) {
      gameState.difficulty = difficulty;
      gameState.down = 1;
      gameState.toGo = 10;
      gameState.fieldPosition = 20;
      gameState.usedQuestions = [];
      
      // Update the player styling with team colors
      const playerElement = document.getElementById('player');
      const colors = teamColors[gameState.playerTeam];
      playerElement.style.backgroundColor = colors.primary;
      
      document.getElementById('difficulty-screen').style.display = 'none';
      document.getElementById('game-interface').style.display = 'block';
      document.getElementById('game-screen').style.display = 'block';
      
      renderKeypad();
      generateProblem();
      movePlayers();
      updateDisplay();
    }

    function renderKeypad() {
      const keypad = document.getElementById('keypad');
      keypad.innerHTML = '';
      
      for (let i = 1; i <= 9; i++) {
        const button = document.createElement('button');
        button.innerText = i;
        button.onclick = () => addToAnswer(i);
        keypad.appendChild(button);
      }
      
      const zeroButton = document.createElement('button');
      zeroButton.innerText = '0';
      zeroButton.onclick = () => addToAnswer(0);
      
      const clearButton = document.createElement('button');
      clearButton.innerText = 'C';
      clearButton.onclick = clearAnswer;
      
      keypad.appendChild(zeroButton);
      keypad.appendChild(clearButton);
    }

    function addToAnswer(digit) {
      if (gameState.userAnswer === '0') {
        gameState.userAnswer = digit.toString();
      } else {
        gameState.userAnswer += digit;
      }
      document.getElementById('answer-display').innerText = gameState.userAnswer;
    }

    function clearAnswer() {
      gameState.userAnswer = '0';
      document.getElementById('answer-display').innerText = '0';
    }

    function updateFieldPosition(yards) {
      gameState.fieldPosition += yards;
      if (gameState.fieldPosition >= 100) {
        scoreTouchdown();
        return;
      }
      updateDisplay();
      movePlayers();
    }

    function movePlayers() {
      const position = (gameState.fieldPosition / 100) * 100;
      document.getElementById('football').style.left = `${position}%`;
      document.getElementById('player').style.left = `${position}%`;
    }

    function updateDisplay() {
      document.getElementById('down').innerText = gameState.down;
      document.getElementById('to-go').innerText = gameState.toGo;
      document.getElementById('field-position').innerText = gameState.fieldPosition;
    }

    function submitAnswer() {
      const answer = parseInt(gameState.userAnswer);
      const timeTaken = (Date.now() - gameState.questionStartTime) / 1000;
      gameState.driveStats.attempts++;
      gameState.driveStats.totalTime += timeTaken;

      if (answer === gameState.currentProblem.answer) {
        const yardRange = getYardRange();
        const yards = Math.floor(Math.random() * (yardRange.max - yardRange.min + 1)) + yardRange.min;
        
        gameState.driveStats.correct++;
        gameState.driveStats.totalYards += yards;
        gameState.toGo -= yards;
        
        if (gameState.toGo <= 0) {
          gameState.driveStats.firstDowns++;
          gameState.down = 1;
          gameState.toGo = 10;
          showNotification('success', 'FIRST DOWN! ðŸˆ', 2000);
        } else {
          gameState.down++;
        }

        updateFieldPosition(yards);

        if (gameState.down > 4) {
          showNotification('warning', 'TURNOVER ON DOWNS', 2500);
          setTimeout(showStats, 2600);
          return;
        }
      } else {
        gameState.down++;
        showNotification('warning', `Incomplete!\nCorrect Answer: ${gameState.currentProblem.answer}`, 2500);
        
        if (gameState.down > 4) {
          setTimeout(() => {
            showNotification('warning', 'TURNOVER ON DOWNS', 2500);
          }, 2600);
          setTimeout(showStats, 5200);
          return;
        }
      }

      gameState.userAnswer = '0';
      document.getElementById('answer-display').innerText = '0';
      generateProblem();
    }

    function showStats() {
      const modal = document.getElementById('stats-modal');
      const avgTime = gameState.driveStats.attempts ? 
        (gameState.driveStats.totalTime / gameState.driveStats.attempts).toFixed(1) : 0;
      const accuracy = gameState.driveStats.attempts ? 
        ((gameState.driveStats.correct / gameState.driveStats.attempts) * 100).toFixed(1) : 0;

      document.getElementById('difficulty-level').innerText = gameState.difficulty;
      document.getElementById('avg-time').innerText = `${avgTime}s`;
      document.getElementById('accuracy').innerText = `${accuracy}%`;
      document.getElementById('total-yards').innerText = gameState.driveStats.totalYards;
      document.getElementById('first-downs').innerText = gameState.driveStats.firstDowns;
      document.getElementById('total-questions').innerText = gameState.driveStats.attempts;

      // Save results to CSV
      saveGameResults();

      // Clear existing buttons except print
      const buttonContainer = document.querySelector('.modal-buttons');
      buttonContainer.innerHTML = '<button class="modal-button print-button" onclick="printStats()">Print Stats</button>';

      // Add level selection button
      const levelSelectButton = document.createElement('button');
      levelSelectButton.className = 'modal-button';
      levelSelectButton.style.background = '#0b3d91';
      levelSelectButton.style.color = 'white';
      levelSelectButton.innerText = 'Choose Level';
      levelSelectButton.onclick = returnToLevelSelect;
      buttonContainer.appendChild(levelSelectButton);

      // Add retry button
      const retryButton = document.createElement('button');
      retryButton.className = 'modal-button';
      retryButton.style.background = '#ffb400';
      retryButton.innerText = 'Retry This Level';
      retryButton.onclick = () => {
        modal.style.display = 'none';
        startGame(gameState.difficulty);
      };
      buttonContainer.appendChild(retryButton);

      // Check if player qualifies for next level
      if (parseFloat(avgTime) < 30 && parseFloat(accuracy) >= 90) {
        let nextLevel;
        switch(gameState.difficulty) {
          case 'rookie':
            nextLevel = 'pro';
            break;
          case 'pro':
            nextLevel = 'allPro';
            break;
          case 'allPro':
            nextLevel = 'allMadden';
            break;
          case 'allMadden':
            nextLevel = null;
            break;
        }
        
        if (nextLevel && !gameState.unlockedLevels.includes(nextLevel)) {
          gameState.unlockedLevels.push(nextLevel);
          
          setTimeout(() => {
            showNotification('success', 
              `ðŸ† NEW LEVEL UNLOCKED! ðŸ†\n${nextLevel.toUpperCase()}\nAvg Time: ${avgTime}s\nAccuracy: ${accuracy}%`, 
              4000
            );
          }, 1000);

          updateDifficultyButtons();

          // Add try next level button
          const nextLevelButton = document.createElement('button');
          nextLevelButton.className = 'modal-button';
          nextLevelButton.style.background = '#4CAF50';
          nextLevelButton.style.color = 'white';
          nextLevelButton.innerText = `Try ${nextLevel} Level`;
          nextLevelButton.onclick = () => {
            modal.style.display = 'none';
            startGame(nextLevel);
          };
          buttonContainer.appendChild(nextLevelButton);
        }
      }

      modal.style.display = 'block';
    }

    function scoreTouchdown() {
      showNotification('success', 'TOUCHDOWN!!! ðŸˆ', 3000);
      setTimeout(showStats, 3100);
    }

    function startNewDrive() {
      const unlockedLevels = gameState.unlockedLevels;
      const currentDifficulty = gameState.difficulty;
      const playerName = gameState.playerName;
      const playerTeam = gameState.playerTeam;
      
      gameState = {
        playerName: playerName,
        playerTeam: playerTeam,
        difficulty: currentDifficulty,
        unlockedLevels: unlockedLevels,
        down: 1,
        toGo: 10,
        fieldPosition: 20,
        currentProblem: null,
        userAnswer: '0',
        questionStartTime: 0,
        usedQuestions: [],
        driveStats: {
          attempts: 0,
          correct: 0,
          totalTime: 0,
          firstDowns: 0,
          totalYards: 0
        }
      };
      
      document.getElementById('stats-modal').style.display = 'none';
      updateDisplay();
      movePlayers();
      generateProblem();
    }

    function returnToLevelSelect() {
      document.getElementById('stats-modal').style.display = 'none';
      document.getElementById('game-interface').style.display = 'none';
      document.getElementById('difficulty-screen').style.display = 'block';
      updateDifficultyButtons();
    }

    function printStats() {
      window.print();
    }

    function updateDifficultyButtons() {
    document.querySelectorAll('.difficulty-button').forEach(button => {
        const difficulty = button.dataset.difficulty;
        button.classList.remove('unlocked', 'locked');
        button.disabled = !gameState.unlockedLevels.includes(difficulty);
        
        if (gameState.unlockedLevels.includes(difficulty)) {
            button.classList.add('unlocked');
            button.style.cursor = 'pointer';
            button.onclick = () => startGame(difficulty);
        } else {
            button.classList.add('locked');
            button.style.cursor = 'not-allowed';
            button.onclick = null;
        }
    });
}

// Initialize welcome screen and difficulty buttons on load
document.addEventListener('DOMContentLoaded', () => {
    initializeWelcomeScreen();
    updateDifficultyButtons();
});

// Add submit button listener
document.getElementById('submit-button').addEventListener('click', submitAnswer);

  </script>
</body>
</html>